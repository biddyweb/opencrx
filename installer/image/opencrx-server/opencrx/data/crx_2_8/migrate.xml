<project 
	name="opencrx-server-migrate" 
	xmlns:antcontrib="antlib:net.sf.antcontrib"
>
        <property name="dst.db.file" value="crx_2_8.script" />
        <property name="src.db.file" value="../../../data/crx_2_7/crx_2_7.script" />
        
	<target name="migrate">
		<!-- Backup destination database file -->
		<copy file="${dst.db.file}" tofile="${dst.db.file}.backup" />
		<copy file="${dst.db.file}" tofile="${dst.db.file}.schema">
		    <filterchain>
		      <linecontainsregexp negate="true">
				<regexp pattern="INSERT INTO " />
		      </linecontainsregexp>
		    </filterchain>
		</copy>
		<!-- Take preferences from dst database -->
		<copy file="${dst.db.file}" tofile="${dst.db.file}.prefs">
		    <filterchain>
		      <linecontainsregexp negate="false">
				<regexp pattern="INSERT INTO PREFS_PREFERENCE" />
		      </linecontainsregexp>
		    </filterchain>
		</copy>
		<!-- Take data froms source database -->
		<copy file="${src.db.file}" tofile="${dst.db.file}.data">
		    <filterchain>
				<linecontainsregexp negate="false">
					<regexp pattern="INSERT INTO " />
				</linecontainsregexp>
				<linecontainsregexp negate="true">
					<regexp pattern="INSERT INTO OOCKE1_CALENDARPROFILE" />
				</linecontainsregexp>
				<linecontainsregexp negate="true">
					<regexp pattern="INSERT INTO OOCKE1_CALENDARFEED" />
				</linecontainsregexp>
				<linecontainsregexp negate="true">
					<regexp pattern="INSERT INTO PREFS_PREFERENCE" />
				</linecontainsregexp>
		    </filterchain>
		</copy>
		<!-- Contact schema, prefs and data -->
		<concat destfile="${dst.db.file}" >
		    <fileset file="${dst.db.file}.schema" />
		    <fileset file="${dst.db.file}.prefs" />
		    <fileset file="${dst.db.file}.data" />
		</concat>
		<!-- Cleanup -->
		<delete file="${dst.db.file}.schema" />	
		<delete file="${dst.db.file}.prefs" />	
		<delete file="${dst.db.file}.data" />
	</target>
	
</project>
